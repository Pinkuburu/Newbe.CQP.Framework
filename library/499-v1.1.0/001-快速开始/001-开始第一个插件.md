# 开始第一个插件

## 环境要求

- .Net Framework 4.5.2 及以上
- Visual Studio 2015 update 3 及以上(推荐 2017)

> 以下内容均采用vs2017作为演示IDE

## 新建项目

项目名称至少需要包含三部分，形如AAA.BBB.CCC的形式。

![新建插件项目](assets/001/001-b8b344fa.png)

## 安装Newbe.CQP.Framework

使用nuget安装Newbe.CQP.Framework。

> 若想要安装最新的开发版，可以勾选"包含预发行版"

![nuget安装Newbe.CQP.Framework](assets/001/001-706d8a18.png)

安装完毕后，项目中应当出现以下文件夹：

![项目中的Newbe.CQP.Framework文件夹](assets/499/001-c821cafb.png)

## 重命名dll和json文件

- 重命名`Newbe.CQP.Framework/ForPlugin/Newbe.CQP.Framework.ApiExporter.dll`文件，使其与你的项目名称一致。
- 重命名`Newbe.CQP.Framework/ForPlugin/Newbe.CQP.Framework.json`文件，使其与你的项目名称一致。

> 若使用Newbe.CQP.Framework.Tools.MSBuildTask则，重命名`Newbe.CQP.Framework.ApiExporter.dll`将不是必要的步骤，Newbe.CQP.Framework.Tools.MSBuildTask的使用方法可以在下文中找到。

![重命名文件](assets/499/001-3b4c53df.png)

## 按照需求修改json文件内容

如果只是快速运行demo，则不需要修改json，或需要开发更多功能请参看[json文件详细修改教程](http://d.cqp.me/Pro/%E5%BC%80%E5%8F%91#.E5.BA.94.E7.94.A8.E4.BF.A1.E6.81.AF.28.5Bappid.5D.json.29)。

## 新建PluginBase实现类

添加 MainPlugin.cs文件(此类名随意，文件名随意)，继承Newbe.CQP.Framework.PluginBase作为基类。

实现 AppId 抽象属性 作为插件的Id，此处使用Newbe.CQP.Plugins.FirstPlugin，AppId需要与程序集名称相同。

```csharp
using Newbe.CQP.Framework;

namespace Newbe.CQP.Plugins.FirstPlugin
{
    public class MainPlugin : PluginBase
    {
        public MainPlugin(ICoolQApi coolQApi) : base(coolQApi)
        {
        }
        /// <summary>
        /// AppId需要与程序集名称相同
        /// </summary>
        public override string AppId => "Newbe.CQP.Plugins.FirstPlugin";
    }
}
```

## 重写需要的事件

例如此处想要监听私聊事件，则重写ProcessPrivateMessage函数，并将消息回发给发送者，代码如下:

```csharp
using Newbe.CQP.Framework;

namespace Newbe.CQP.Plugins.FirstPlugin
{
    public class MainPlugin : PluginBase
    {
        public MainPlugin(ICoolQApi coolQApi) : base(coolQApi)
        {
        }

        /// <summary>
        /// AppId需要与程序集名称相同
        /// </summary>
        public override string AppId => "Newbe.CQP.Plugins.FirstPlugin";

        public override int ProcessPrivateMessage(int subType, int sendTime, long fromQQ, string msg, int font)
        {
            //使用CoolQApi将信息回发给发送者
            CoolQApi.SendPrivateMsg(fromQQ, msg);
            return base.ProcessPrivateMessage(subType, sendTime, fromQQ, msg, font);
        }
    }
}
```

## 生成解决方案

## 开启酷Q开发者模式

打开酷Q文件夹下的 `conf\CQP.cfg` 文件，并在文件末尾插入以下两行，即可开启开发者模式。

```ini
[Debug]
DeveloperMode=1
```

## 复制文件到酷Q

安装nuget包[Newbe.CQP.Framework.Tools.MSBuildTask](https://www.nuget.org/packages/Newbe.CQP.Framework.Tools.MSBuildTask/)。

修改存在于项目根目录的`Newbe.CQP.Framework.props`文件中的`NewbePluginName`节点内容，此处，使用Newbe.CQP.Plugins.FirstPlugin。

修改后结果如下：

```xml
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <NewbePluginName>Newbe.CQP.Plugins.FirstPlugin</NewbePluginName>
  </PropertyGroup>
</Project>
```

设置完毕后，重新生成项目，在bin下将会出现CQP文件夹。

将CQP内容全部复制到酷Q的同级目录，复制结果将会如下所示：

```bash
│  Autofac.dll                             #来自ForMain文件夹
│  CQP.exe
│  Newbe.CQP.Framework.dll                 #来自ForMain文件夹
│  Newbe.CQP.Framework.PluginLoader.dll    #来自ForMain文件夹
├─app
│      Newbe.CQP.Plugins.FirstPlugin.dll   #来自ForPlugin文件夹
│      Newbe.CQP.Plugins.FirstPlugin.json  #来自ForPlugin文件夹
├─bin
│      CQP.dll
│      gzip.dll
│      htmlayout.dll
│      libeay32.dll
│      libiconv.dll
│      sqlite3.dll
│      zlib1.dll
├─conf
│      CQA.key
│      CQP.cfg
└─Newbe.CQP.Plugins.FirstPlugin            #来自插件的bin
        Autofac.dll
        Newbe.CQP.Framework.dll
        Newbe.CQP.Plugins.FirstPlugin.dll
        Newbe.CQP.Plugins.FirstPlugin.pdb
```

> 若不希望安装Newbe.CQP.Framework.Tools.MSBuildTask，或者安装后出现无法生成的困难，也可以选择[手动复制dll](?file=499-v1.1.0/001-快速开始/002-如何手动复制插件dll "如何手动复制插件dll")，**注意，这是情非得已的情况**。

## 启用插件

启动CQP，在插件管理中将新添加的插件启用。

## 成功！

发送消息给酷Q机器人，你就会收到机器人回发的信息。
